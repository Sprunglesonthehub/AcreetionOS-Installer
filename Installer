#!/bin/bash

# ===================== ArchWiki Install Script =====================
# Version: 30.0
# WARNING: Use with caution! This will wipe your disk!

LOG_FILE="arch_install.log"

# Style
C_ERASE="\Zb\Z1ERASE\Zn"
C_DANGER_BG="--colors --backtitle \Zb\Z1DANGER\Zn"

# Global State
NETWORK_CONFIGURED=false
DISK_CONFIGURED=false
USER_CONFIGURED=false
INSTALLATION_DONE=false
VM_TYPE="None"

TARGET_DISK=""
ARCH_PART_SIZE="50"
HOSTNAME="archlinux"
USERNAME="user"
USER_PASSWORD="password"
DUAL_BOOT=false

PACSTRAP_EXTRA_PKGS=()
CHROOT_EXTRA_PKGS=()
KERNEL_PACKAGE="linux"
KERNEL_HEADERS_PACKAGE="linux-headers"

# --- Utility functions ---
run_cmd() {
    stdbuf -oL -eL "$@" >> "$LOG_FILE" 2>&1
    return ${PIPESTATUS[0]}
}
add_pkg() {
    local arr_name="$1"
    local pkg="$2"
    eval "local arr=(\"\${${arr_name}[@]}\")"
    for p in "${arr[@]}"; do
        [ "$p" == "$pkg" ] && return
    done
    eval "${arr_name}+=(\"$pkg\")"
}

# --- UI functions ---
tui_welcome() {
    dialog --backtitle "ArchLinux Installation" --title "Welcome" --msgbox \
        "Welcome! This script will install Arch Linux.\n\nIt will wipe your disk.\nBack up data!" 10 70
}
tui_virtualization() {
    dialog --backtitle "ArchLinux Installation" --title "VM Detection" --yesno \
        "Is this inside a Virtual Machine?" 8 70
    if [ $? -eq 0 ]; then
        VM_TYPE=$(dialog --backtitle "ArchLinux Installation" --title "Select VM" --radiolist \
            "Choose your VM" 15 70 4 \
            "VirtualBox" "Oracle VirtualBox" "on" \
            "QEMU" "QEMU/KVM" "off" \
            "VMware" "VMware" "off" \
            "Hyper-V" "Hyper-V" "off" 2>&1 >/dev/tty)
        case "$VM_TYPE" in
            "VirtualBox") add_pkg CHROOT_EXTRA_PKGS "virtualbox-guest-utils" ;;
            "QEMU") add_pkg CHROOT_EXTRA_PKGS "qemu-guest-agent" "spice-vdagent" ;;
            "VMware") add_pkg CHROOT_EXTRA_PKGS "open-vm-tools" ;;
            "Hyper-V") add_pkg CHROOT_EXTRA_PKGS "hyperv" ;;
            *) VM_TYPE="None" ;;
        esac
    fi
}
tui_network() {
    while true; do
        CHOICE=$(dialog --backtitle "ArchLinux Installation" --title "Network" --menu "Choose:" 15 55 3 \
            1 "Connect Wi-Fi" 2 "Use Wired" 3 "Continue" 2>&1 >/dev/tty)
        [ $? -ne 0 ] && return
        case "$CHOICE" in
            1)
                dialog --backtitle "ArchLinux Installation" --infobox "Scanning Wi-Fi..." 4 40
                sleep 1
                local networks=("AcreetionWiFi" "Strong" "CinnamonNet" "Medium" "Public WiFi" "Weak")
                WIFI_CHOICE=$(dialog --backtitle "ArchLinux Installation" --menu "Select Wi-Fi" 15 50 4 "${networks[@]}" 2>&1 >/dev/tty)
                [ $? -ne 0 ] && continue
                WIFI_PASS=$(dialog --backtitle "ArchLinux Installation" --passwordbox "Password for $WIFI_CHOICE" 8 40 2>&1 >/dev/tty)
                [ $? -ne 0 ] && continue
                # Assume success
                ping -c 1 archlinux.org >/dev/null 2>&1
                dialog --backtitle "ArchLinux Installation" --msgbox "Connected!" 6 30
                timedatectl set-ntp true >/dev/null 2>&1
                NETWORK_CONFIGURED=true
                return
                ;;
            2)
                ping -c 1 archlinux.org >/dev/null 2>&1
                dialog --backtitle "ArchLinux Installation" --msgbox "Connected!" 6 30
                timedatectl set-ntp true >/dev/null 2>&1
                NETWORK_CONFIGURED=true
                return
                ;;
            3) NETWORK_CONFIGURED=true; return ;;
        esac
    done
}
tui_disk() {
    # List disks
    local disks=()
    while read -r dev; do
        disks+=("$dev" "$(lsblk -dno SIZE,MODEL "$dev")")
    done < <(lsblk -dno NAME | sed 's/^/\/dev\//')

    local disk_choice
    disk_choice=$(dialog --backtitle "ArchLinux Installation" --title "Select Disk" --radiolist \
        "Available disks:" 20 70 10 \
        "${disks[@]}" 2>&1 >/dev/tty)
    [ $? -ne 0 ] && return
    TARGET_DISK="$disk_choice"

    # Detect Windows partition
    local win_part
    win_part=$(lsblk -plno NAME,FSTYPE "$TARGET_DISK" | grep -i "ntfs" | awk 'NR==1 {print $1}')

    # Decide mode
    local choice
    if [ -n "$win_part" ]; then
        choice=$(dialog --backtitle "ArchLinux Installation" --title "Windows detected" --menu \
            "Detected Windows NTFS partition.\nChoose:" 15 70 2 \
            1 "Dual boot (shrink Windows)" \
            2 "Erase Windows" 2>&1 >/dev/tty)
        [ $? -ne 0 ] && return
        if [ "$choice" = "1" ]; then
            DUAL_BOOT=true
            ARCH_PART_SIZE=$(dialog --backtitle "ArchLinux Installation" --title "Partition Size (GB)" --inputbox \
                "Enter size in GB for Arch root" 8 60 "$ARCH_PART_SIZE" 2>&1 >/dev/tty)
            [ $? -ne 0 ] && return
        else
            DUAL_BOOT=false
        fi
    else
        if dialog --backtitle "ArchLinux Installation" --title "No Windows" --yesno \
            "No Windows partition detected. Proceed to wipe entire disk?" 8 60; then
            DUAL_BOOT=false
        else
            return
        fi
    fi

    # Confirm wipe
    if dialog --backtitle "ArchLinux Installation" --title "Warning" --yesno \
        "This will erase all data on $TARGET_DISK. Proceed?" 8 60; then
        partition_and_format
        DISK_CONFIGURED=true
    else
        return
    fi
}
partition_and_format() {
    echo "Partitioning disk: $TARGET_DISK" >> "$LOG_FILE"
    # Unmount all
    umount -R /mnt 2>/dev/null || true
    umount ${TARGET_DISK}* 2>/dev/null || true

    # Wipe
    run_cmd wipefs -a "$TARGET_DISK"

    # Detect UEFI or BIOS
    if [ -d /sys/firmware/efi ]; then
        echo "UEFI detected, GPT." >> "$LOG_FILE"
        run_cmd parted --script "$TARGET_DISK" mklabel gpt
        # EFI partition 1G
        run_cmd parted --script "$TARGET_DISK" mkpart primary fat32 1MiB 1GiB
        run_cmd parted --script "$TARGET_DISK" set 1 esp on
        # Root partition remaining space
        run_cmd parted --script "$TARGET_DISK" mkpart primary ext4 1GiB 100%
        sleep 2
        if [[ "$TARGET_DISK" == *"nvme"* ]]; then
            EFI_PART="${TARGET_DISK}p1"
            ROOT_PART="${TARGET_DISK}p2"
        else
            EFI_PART="${TARGET_DISK}1"
            ROOT_PART="${TARGET_DISK}2"
        fi
        run_cmd mkfs.fat -F32 "$EFI_PART"
        run_cmd mkfs.ext4 -F "$ROOT_PART"
        run_cmd mount "$ROOT_PART" /mnt
        mkdir -p /mnt/boot
        run_cmd mount "$EFI_PART" /mnt/boot
    else
        echo "BIOS detected, MBR." >> "$LOG_FILE"
        run_cmd parted --script "$TARGET_DISK" mklabel msdos
        # Single root partition
        run_cmd parted --script "$TARGET_DISK" mkpart primary ext4 1MiB 100%
        sleep 2
        if [[ "$TARGET_DISK" == *"nvme"* ]]; then
            ROOT_PART="${TARGET_DISK}p1"
        else
            ROOT_PART="${TARGET_DISK}1"
        fi
        run_cmd mkfs.ext4 -F "$ROOT_PART"
        run_cmd mount "$ROOT_PART" /mnt
    fi
}
install_base() {
    # Create pacman config
    cat > /tmp/pacman.conf <<EOF
[options]
Architecture = auto
SigLevel = Never
LocalFileSigLevel = Optional

[custom-repo]
SigLevel = Optional
Server = https://darrengames.ddns.net:1500/repo/\$arch
EOF
    local pkgs=("base" "$KERNEL_PACKAGE" "linux-firmware" "$KERNEL_HEADERS_PACKAGE" "mkinitcpio" "sudo" "nano" "networkmanager" "git" "vim" "efibootmgr")
    [ "$DUAL_BOOT" = true ] && pkgs+=("os-prober")
    pkgs+=("${PACSTRAP_EXTRA_PKGS[@]}")

    stdbuf -oL -eL pacstrap -C /tmp/pacman.conf -K /mnt "${pkgs[@]}" | tee -a "$LOG_FILE"
    rm /tmp/pacman.conf
}
configure_chroot() {
    cat > /mnt/setup_chroot.sh <<'EOF'
#!/bin/bash
set -e
# Install systemd-boot
bootctl --path=/boot install

# Create loader directory
mkdir -p /boot/loader/entries

# Create loader.conf
cat > /boot/loader/loader.conf <<'EOF2'
default arch
timeout 4
console-mode max
editor 0
EOF2

# Create boot entry
cat > /boot/loader/entries/arch.conf <<'EOF2'
title   Arch Linux
linux   /vmlinuz-linux
initrd  /initramfs-linux.img
options root=PARTUUID=$(blkid -s PARTUUID -o value /dev/disk/by-label/ArchRoot) rw
EOF2

# Additional user/system setup can be added here
EOF
    chmod +x /mnt/setup_chroot.sh
    arch-chroot /mnt /setup_chroot.sh
    rm /mnt/setup_chroot.sh
}
run_install() {
    partition_and_format
    install_base
    genfstab -U /mnt >> /mnt/etc/fstab
    configure_chroot
}
# =================== Main ===================
main() {
    if ! command -v dialog &> /dev/null; then echo "Please install dialog"; exit 1; fi
    > "$LOG_FILE"
    tui_welcome
    tui_virtualization
    tui_network
    tui_disk
    if [ "$DISK_CONFIGURED" != "true" ]; then
        echo "Disk not configured, exiting."
        exit 1
    fi
    if dialog --backtitle "ArchLinux Installer" --title "Ready to install" --yesno "Proceed with installation?" 8 60; then
        run_install
        dialog --backtitle "ArchLinux Installer" --msgbox "Installation complete! Reboot now." 8 50
    fi
}
main "$@"
